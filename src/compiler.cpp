#include "compiler.h"

#include <sstream>

namespace up
{
    Compiler::Compiler()
        : scanner(*this), parser(scanner, *this)
    {}

    Compiler::~Compiler()
    {
        for (const Statement *s : statements)
            delete s;
    }

    int Compiler::parse(const std::string &FILE_PATH)
    {
        // Init variables
        program = "// Code generated by the Up compiler\n";


        // Scan
        int ret = 0;
        ret = scan(FILE_PATH);

        if (ret != 0)
            return ret;

        // Generate
        ret = generate();

        if (ret != 0)
            return ret;

        // TODO : Write into a file
        cout << "Transpiled program :\n\n";
        cout << program;

        return ret;
    }

    int Compiler::scan(const std::string &FILE_PATH)
    {
        if (!scanner.beginParse(FILE_PATH))
        {
            scanner.endParse();
            return -1;
        }

        int ret = parser.parse();

        scanner.endParse();

        return ret;
    }

    int Compiler::generate()
    {
        // !!! Tests //
        program += "int main() {\n";

        // Add statements
        for (auto s : statements)
            program += "\t" + s->toString() + "\n";

        // End of main
        program += "\treturn 0;\n}\n";
        // !!! End tests //

        return 0;
    }
} // namespace up
